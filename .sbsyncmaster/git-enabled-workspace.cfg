# Remove package tests that trigger GCC's raw string bug
-run-after-sync "rm -f matlab/src/eml/pkgtest/tMcosInference.cpp matlab/src/eml/pkgtest/tSSAInference.cpp"

# Set-up essential context
-cfg cgir_syncmaster_debug
-gen-mtoolrc-for dev_cgir_shared_branch

# Make workspace writeable and clean out obvious trash
-run-after-sync "time -p chmod -R u+w *"
-run-after-sync "rm -rf .sbtools/global GPATH GRTAGS GTAGS ID"
-run-after-sync "if [ -e .git ] ; then chmod -R a+w .git ; rm -rf .git ; fi"

# Apply published workspace patches
#-run-after-sync "sbpatch"

# Do the sbsmartbuild (touching force.txt seems to have magical effects)
#-run-after-sync "echo 'matlab/src/cg_ir/export/include/cg_ir/fwd/common.hpp' > force.txt"

# Regenerate matlab/toolbox/local/toolbox_cache-ARCH.xml
-run-after-sync "sbgentbxcache"

# git-enable this workspace
-run-after-sync "git init"
-run-after-sync "git config --local user.name  ${GIT_USER_NAME}"
-run-after-sync "git config --local user.email ${GIT_USER_EMAIL}"

# Create a set of .gitignore files to exclude binary items
# and subtrees that I will never visit
-run-after-sync "${HOME}/.sbsyncmaster/add-git-ignore-files"
# Move the top-level .gitignore to its canonical location
-run-after-sync "mv .gitignore .git/info/exclude"

# Initial add and commit per the .gitignores (no compression)
-run-after-sync "time -p git add matlab >/dev/null 2>&1"
-run-after-sync "git config --local core.compression 0"
-run-after-sync "time -p git commit -m 'Fresh snapshot' >/dev/null 2>&1"
# Now repack with maximal compression
-run-after-sync "git config --local core.compression 9"
-run-after-sync "time -p git repack -a -d -f --depth=50 --window=250 --write-bitmap-index"

# Generate the per component lists of files maintained in a parallel
# directory tree beneath matlab/.sbtools/global but drop the nearly
# useless list of derived files
-run-after-sync "time -p sblocate -gendb"
-run-after-sync "rm -rf .sbtools/global/matlab/derived"

# Use remaining files database to generate the tags database
-run-after-sync "time -p sbglobal -num-threads 12 -gentags matlab/src matlab/toolbox"

# Use my newer versions of GNU global and gtags if available
-run-after-sync "if [ -e ${HOME}/bin/mathworks-global ] ; then PATH=/usr/local/bin:${PATH} time -p ${HOME}/bin/mathworks-global ; fi"

# Build emacs' WorkSpace Files index (for my wsf.el package)
-run-after-sync "time -p /usr/bin/emacs --batch --load ${HOME}/.emacs --eval='(load-library \"wsf\")' -f wsf--current-completions -f save-buffers-kill-emacs"

# Hide symbols that we will likely never use
-run-after-sync "find -name \"*.so.dbg\" -exec mv {} {}_HIDE \;"
# * libraries needed so breaksegv works:
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwmcr.so.dbg_HIDE              ]; then mv matlab/bin/glnxa64/libmwmcr.so.dbg_HIDE              matlab/bin/glnxa64/libmwmcr.so.dbg              ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwfl.so.dbg_HIDE               ]; then mv matlab/bin/glnxa64/libmwfl.so.dbg_HIDE               matlab/bin/glnxa64/libmwfl.so.dbg               ;fi"
# * libraries I tend to work on:
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcg_ir.so.dbg_HIDE            ]; then mv matlab/bin/glnxa64/libmwcg_ir.so.dbg_HIDE            matlab/bin/glnxa64/libmwcg_ir.so.dbg            ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_algorithm.so.dbg_HIDE   ]; then mv matlab/bin/glnxa64/libmwcgir_algorithm.so.dbg_HIDE   matlab/bin/glnxa64/libmwcgir_algorithm.so.dbg   ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_analysis.so.dbg_HIDE    ]; then mv matlab/bin/glnxa64/libmwcgir_analysis.so.dbg_HIDE    matlab/bin/glnxa64/libmwcgir_analysis.so.dbg    ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_cgel.so.dbg_HIDE        ]; then mv matlab/bin/glnxa64/libmwcgir_cgel.so.dbg_HIDE        matlab/bin/glnxa64/libmwcgir_cgel.so.dbg        ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_clair.so.dbg_HIDE       ]; then mv matlab/bin/glnxa64/libmwcgir_clair.so.dbg_HIDE       matlab/bin/glnxa64/libmwcgir_clair.so.dbg       ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_construct.so.dbg_HIDE   ]; then mv matlab/bin/glnxa64/libmwcgir_construct.so.dbg_HIDE   matlab/bin/glnxa64/libmwcgir_construct.so.dbg   ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_cpp_emitter.so.dbg_HIDE ]; then mv matlab/bin/glnxa64/libmwcgir_cpp_emitter.so.dbg_HIDE matlab/bin/glnxa64/libmwcgir_cpp_emitter.so.dbg ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_dvir.so.dbg_HIDE        ]; then mv matlab/bin/glnxa64/libmwcgir_dvir.so.dbg_HIDE        matlab/bin/glnxa64/libmwcgir_dvir.so.dbg        ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_fe.so.dbg_HIDE          ]; then mv matlab/bin/glnxa64/libmwcgir_fe.so.dbg_HIDE          matlab/bin/glnxa64/libmwcgir_fe.so.dbg          ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_fixpt.so.dbg_HIDE       ]; then mv matlab/bin/glnxa64/libmwcgir_fixpt.so.dbg_HIDE       matlab/bin/glnxa64/libmwcgir_fixpt.so.dbg       ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_float2fixed.so.dbg_HIDE ]; then mv matlab/bin/glnxa64/libmwcgir_float2fixed.so.dbg_HIDE matlab/bin/glnxa64/libmwcgir_float2fixed.so.dbg ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_gpu.so.dbg_HIDE         ]; then mv matlab/bin/glnxa64/libmwcgir_gpu.so.dbg_HIDE         matlab/bin/glnxa64/libmwcgir_gpu.so.dbg         ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_hdl.so.dbg_HIDE         ]; then mv matlab/bin/glnxa64/libmwcgir_hdl.so.dbg_HIDE         matlab/bin/glnxa64/libmwcgir_hdl.so.dbg         ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_interp.so.dbg_HIDE      ]; then mv matlab/bin/glnxa64/libmwcgir_interp.so.dbg_HIDE      matlab/bin/glnxa64/libmwcgir_interp.so.dbg      ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_mi.so.dbg_HIDE          ]; then mv matlab/bin/glnxa64/libmwcgir_mi.so.dbg_HIDE          matlab/bin/glnxa64/libmwcgir_mi.so.dbg          ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_plc.so.dbg_HIDE         ]; then mv matlab/bin/glnxa64/libmwcgir_plc.so.dbg_HIDE         matlab/bin/glnxa64/libmwcgir_plc.so.dbg         ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_polly.so.dbg_HIDE       ]; then mv matlab/bin/glnxa64/libmwcgir_polly.so.dbg_HIDE       matlab/bin/glnxa64/libmwcgir_polly.so.dbg       ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_spike.so.dbg_HIDE       ]; then mv matlab/bin/glnxa64/libmwcgir_spike.so.dbg_HIDE       matlab/bin/glnxa64/libmwcgir_spike.so.dbg       ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_support.so.dbg_HIDE     ]; then mv matlab/bin/glnxa64/libmwcgir_support.so.dbg_HIDE     matlab/bin/glnxa64/libmwcgir_support.so.dbg     ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_tests.so.dbg_HIDE       ]; then mv matlab/bin/glnxa64/libmwcgir_tests.so.dbg_HIDE       matlab/bin/glnxa64/libmwcgir_tests.so.dbg       ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_tfl.so.dbg_HIDE         ]; then mv matlab/bin/glnxa64/libmwcgir_tfl.so.dbg_HIDE         matlab/bin/glnxa64/libmwcgir_tfl.so.dbg         ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_vm_rt.so.dbg_HIDE       ]; then mv matlab/bin/glnxa64/libmwcgir_vm_rt.so.dbg_HIDE       matlab/bin/glnxa64/libmwcgir_vm_rt.so.dbg       ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_vm.so.dbg_HIDE          ]; then mv matlab/bin/glnxa64/libmwcgir_vm.so.dbg_HIDE          matlab/bin/glnxa64/libmwcgir_vm.so.dbg          ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgir_xform.so.dbg_HIDE       ]; then mv matlab/bin/glnxa64/libmwcgir_xform.so.dbg_HIDE       matlab/bin/glnxa64/libmwcgir_xform.so.dbg       ;fi"
#-run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgxert.so.dbg_HIDE           ]; then mv matlab/bin/glnxa64/libmwcgxert.so.dbg_HIDE           matlab/bin/glnxa64/libmwcgxert.so.dbg           ;fi"
 -run-after-sync "if [ -f matlab/bin/glnxa64/libmwcgxe.so.dbg_HIDE             ]; then mv matlab/bin/glnxa64/libmwcgxe.so.dbg_HIDE             matlab/bin/glnxa64/libmwcgxe.so.dbg             ;fi"

# At the bottom of the log show the size of the .git repository
-run-after-sync "du -sh .git"
