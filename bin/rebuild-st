#!/bin/dash

set -e

if [ ! -f "st.info" ]; then
   echo "Working directory ( $(pwd) ) is not the root of an st source tree."; exit 1
fi

rm -f *.diff*

cat >st-no-bold-colors.diff <<EOF
diff --git a/st.c b/st.c
index 64e2cec..13ceadc 100644
--- a/st.c
+++ b/st.c
@@ -3680,7 +3680,7 @@ xdrawglyphfontspecs(const XftGlyphFontSpec *specs, Glyph base, int len, int x, i
 
 	/* Change basic system colors [0-7] to bright system colors [8-15] */
 	if ((base.mode & ATTR_BOLD_FAINT) == ATTR_BOLD && BETWEEN(base.fg, 0, 7))
-		fg = &dc.col[base.fg + 8];
+		fg = &dc.col[base.fg];
 
 	if (IS_SET(MODE_REVERSE)) {
 		if (fg == &dc.col[defaultfg]) {
-- 
2.4.2
EOF

sed -i.bak \
    -e 's/if(BETWEEN(base.fg, 0, 7))/if(BETWEEN(base.fg, 0, 7) \&\& !(base.mode \& ATTR_FAINT))/g' \
    -e 's/-3164,7 +3164,7/-3224,7 +3224,7/g' \
    st-no-bold-colors.diff


# wget http://st.suckless.org/patches/st-solarized-light.diff  # config.def.h
# wget http://st.suckless.org/patches/st-solarized-dark.diff   # config.def.h
#
# sed -i.bak \
#     -e 's/#073642/#000000/g' \
#     -e 's/#eee8d5/#f0f0f0/g' \
#     -e 's/#002b36/#202020/g' \
#     -e 's/#fdf6e3/#fefefe/g' \
#     -e 's/defaultfg = 12;/defaultfg = 7;/g' \
#     -e 's/defaultbg = 8;/defaultbg = 0;/g' \
#     st-solarized-light.diff st-solarized-dark.diff

cat >st-solarized-light.diff <<EOF
diff --git a/config.def.h b/config.def.h
index 930e468..19f33b5 100644
--- a/config.def.h
+++ b/config.def.h
@@ -70,25 +70,23 @@ static unsigned int tabspaces = 8;
 
 /* Terminal colors (16 first used in escape sequence) */
 static const char *colorname[] = {
-	/* 8 normal colors */
-	"black",
-	"red3",
-	"green3",
-	"yellow3",
-	"blue2",
-	"magenta3",
-	"cyan3",
-	"gray90",
-
-	/* 8 bright colors */
-	"gray50",
-	"red",
-	"green",
-	"yellow",
-	"#5c5cff",
-	"magenta",
-	"cyan",
-	"white",
+	/* solarized light */
+	"#f0f0f0",  /*	0: black    */
+	"#dc322f",  /*	1: red	    */
+	"#859900",  /*	2: green    */
+	"#b58900",  /*	3: yellow   */
+	"#268bd2",  /*	4: blue	    */
+	"#d33682",  /*	5: magenta  */
+	"#2aa198",  /*	6: cyan	    */
+	"#000000",  /*	7: white    */
+	"#fefefe",  /*	8: brblack  */
+	"#cb4b16",  /*	9: brred    */
+	"#93a1a1",  /* 10: brgreen  */
+	"#839496",  /* 11: bryellow */
+	"#657b83",  /* 12: brblue   */
+	"#6c71c4",  /* 13: brmagenta*/
+	"#586e75",  /* 14: brcyan   */
+	"#202020",  /* 15: brwhite  */
 
 	[255] = 0,
 
@@ -103,7 +101,7 @@ static const char *colorname[] = {
  */
 static unsigned int defaultfg = 7;
 static unsigned int defaultbg = 0;
-static unsigned int defaultcs = 256;
+static unsigned int defaultcs = 14;
 
 
 /*
-- 
2.1.4
EOF

cat >st-solarized-dark.diff <<EOF
diff --git a/config.def.h b/config.def.h
index 930e468..650fc13 100644
--- a/config.def.h
+++ b/config.def.h
@@ -70,25 +70,23 @@ static unsigned int tabspaces = 8;
 
 /* Terminal colors (16 first used in escape sequence) */
 static const char *colorname[] = {
-	/* 8 normal colors */
-	"black",
-	"red3",
-	"green3",
-	"yellow3",
-	"blue2",
-	"magenta3",
-	"cyan3",
-	"gray90",
-
-	/* 8 bright colors */
-	"gray50",
-	"red",
-	"green",
-	"yellow",
-	"#5c5cff",
-	"magenta",
-	"cyan",
-	"white",
+	/* solarized dark */
+	"#000000",  /*	0: black    */
+	"#dc322f",  /*	1: red	    */
+	"#859900",  /*	2: green    */
+	"#b58900",  /*	3: yellow   */
+	"#268bd2",  /*	4: blue	    */
+	"#d33682",  /*	5: magenta  */
+	"#2aa198",  /*	6: cyan	    */
+	"#f0f0f0",  /*	7: white    */
+	"#202020",  /*	8: brblack  */
+	"#cb4b16",  /*	9: brred    */
+	"#586e75",  /* 10: brgreen  */
+	"#657b83",  /* 11: bryellow */
+	"#839496",  /* 12: brblue   */
+	"#6c71c4",  /* 13: brmagenta*/
+	"#93a1a1",  /* 14: brcyan   */
+	"#fefefe",  /* 15: brwhite  */
 
 	[255] = 0,
 
@@ -103,7 +101,7 @@ static const char *colorname[] = {
  */
 static unsigned int defaultfg = 7;
 static unsigned int defaultbg = 0;
-static unsigned int defaultcs = 256;
+static unsigned int defaultcs = 14;
 
 
 /*
-- 
2.1.4
EOF

makeSt() {
  git reset --hard
  git pull
  make clean
  echo "Apply: st-no-bold-colors.diff"
  git apply st-no-bold-colors.diff
  echo "Apply: st-solarized-$1.diff"
  git apply st-solarized-$1.diff
  cp config.def.h config.h
  sed -i.bak \
      -e 's/Liberation Mono/Dina/g' \
      -e 's/:pixelsize=12/:pixelsize=16/g' \
      -e 's/:antialias=false/:antialias=false/g' \
      -e 's/:autohint=false/:autohint=false/g' \
    config.h
  CFLAGS='-march=corei7' make
  cp st ~/bin/st-$1
}

makeSt light
makeSt dark

cp config.h st-solarized-light.diff st-solarized-dark.diff /tmp

rm -f *.diff *.bak
