#!/bin/dash

set -e

if [ ! -f "st.info" ]; then
   echo "Working directory ( $(pwd) ) is not the root of an st source tree."; exit 1
fi

wget http://st.suckless.org/patches/st-no-bold-colors.diff   # st.c

sed -i.bak \
    -e 's/if(BETWEEN(base.fg, 0, 7))/if(BETWEEN(base.fg, 0, 7) \&\& !(base.mode \& ATTR_FAINT))/g' \
    -e 's/-3164,7 +3164,7/-3224,7 +3224,7/g' \
    st-no-bold-colors.diff

wget http://st.suckless.org/patches/st-solarized-light.diff  # config.def.h
wget http://st.suckless.org/patches/st-solarized-dark.diff   # config.def.h

sed -i.bak \
    -e 's/#073642/#000000/g' \
    -e 's/#eee8d5/#f0f0f0/g' \
    -e 's/#002b36/#202020/g' \
    -e 's/#fdf6e3/#fefefe/g' \
    -e 's/defaultfg = 12;/defaultfg = 7;/g' \
    -e 's/defaultbg = 8;/defaultbg = 0;/g' \
    st-solarized-light.diff st-solarized-dark.diff

makeSt() {
  git reset --hard
  git pull
  make clean
  git apply st-no-bold-colors.diff
  git apply st-solarized-$1.diff
  cp config.def.h config.h
  sed -i.bak \
      -e 's/Liberation Mono/Dina/g' \
      -e 's/:pixelsize=12/:pixelsize=16/g' \
      -e 's/:antialias=false/:antialias=false/g' \
      -e 's/:autohint=false/:autohint=false/g' \
    config.h
  CFLAGS='-march=corei7' make
  cp st ~/bin/st-$1
}

makeSt light
makeSt dark

cp config.h st-solarized-light.diff st-solarized-dark.diff /tmp

rm -f *.diff *.bak
