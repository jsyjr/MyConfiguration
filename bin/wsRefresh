#!/bin/bash

BINDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
SRCDIR=${BINDIR}/source
. ${SRCDIR}/get_WORKSPACE
. ${SRCDIR}/sbrtEnv

echo

CLONED=$(sbver | grep 'SyncFrom:' | sed -e 's|SyncFrom: /*mathworks/devel/jobarchive/\([^/]*\)/.*$|\1|').latest_pass
echo CLONED= ${CLONED}

BACKUP=local_$(hostname)$(echo ${WORKSPACE} | sed -e 's|/|_|g')_backup/latest
echo BACKUP= ${BACKUP}

echo

sbbackup -opened

# If local git repo is local to the workspace and if it contains both
# commits and a perforce branch then move it to the sibling save area.
if [ -d ${WORKGIT} ] && \
   [ $(git rev-list --count BASE..HEAD) != "0" ] && \
   [ git branch --list | grep -q perforce ]; \
then
    # Ensure existence of the sibling directory
    mkdir -p ${SAVEDIR}
    mv ${WORKGIT} ${SAVEGIT}
    ln -s ${SAVEGIT} ${WORKGIT}
fi

# If actually using the saved git repository via a symbolic link then...
if [ -h ${WORKGIT} ]; then
    # Save any outstand work (both modified and untracked files)
    git stash save --include-untracked
    # Set up the repository to import the new perforce state
    git checkout perforce
fi

# Discard the old workspace and reclone it from the current .latest_pass
cd ..
sbrmtree ${WORKSPACE}
sbclone -no-pdb ${CLONED} ${WORKSPACE}
cd ${WORKSPACE}

# Check for a git repository in a sibling save area
if [ ! -d ${SAVEGIT} ]; then
    # No git repository found, simple restore the sbbackup
    sbrestore -no-prompt -f -r $s/_sbbackup/${BACKUP}
else
    # Use sibling save area's git repo rather than syncmaster's fresh repo
    rm -rf ${WORKGIT}
    ln -s ${SAVEGIT} ${WORKGIT}
    git add -A matlab >/dev/null 2>&1
    JOB=$( sbver | sed -nre '{ /SyncFrom/ s|^.*/mathworks/devel/jobarchive/([^/]*/[^/]*)$|\1|gp }' )
    # Commit this .latest_pass as newest perforce state
    git commit -m "${JOB}" >/dev/null 2>&1

    # Restore the backup
    # sbrestore -no-prompt -f -r $s/_sbbackup/${BACKUP}
    # git commit -m "_sbbackup/${BACKUP}" >/dev/null 2>&1

    # Back to master and merge newest changes from perforce
    git checkout master
    git merge --commit -m "-> ${JOB}" perforce

    # Apply any stashed changes
    git stash apply --index
fi
