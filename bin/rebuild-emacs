#!/bin/dash

# investigate: make MAKEINFO="makeinfo --force"
#
# Also:
# The --without-makeinfo flag doesn't work for me too,
# I have to change MAKEINFO=yes to MAKEINFO=no in the
# Makefile to compile without docs.

set -e

if [ ! -f "src/bitmaps/leftptr.xbm" ]; then
   echo "Working directory ( $(pwd) ) is not the root of an emacs source tree."; exit 1
fi

set +e
make extraclean
make bootstrap-clean
set -e

git reset --hard
git clean -xdf
git pull

# rm -r lisp/cedet test/cedet

./autogen.sh
./configure

set +e
# CFLAGS='-march=corei7 -O3' ./configure  --prefix=/usr/local/emacs --enable-link-time-optimization
CFLAGS='-march=corei7 -O3' ./configure  --prefix=/usr/local/emacs
# CFLAGS='-march=corei7 -O3' make -j8
CFLAGS='-march=corei7 -O3' make

# Dependencies are not complete so parallel builds have sporadic failures.
# Do a first parallel pass to build as much as possible.
make -j8 -k
make -j8 -k doc

# Now do a non-parallel build to get things finished up.
set -e
make bootstrap
make
make doc

(cd lisp ; make autoloads)

echo
echo "Build is complete; performing very simple invocation"
echo
echo
./src/emacs --version
echo
echo Starting emacs
echo
./src/emacs &
echo
echo
